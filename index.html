<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yurin Calendar — Pages + Filters + One‑click PDF</title>
  <!-- jsPDF & AutoTable for direct PDF downloads (no print dialog) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --bg:#0f1217; /* dark grid background */
      --panel:#121722;
      --panel-2:#0e1420;
      --muted:#9aa3b2;
      --text:#e6e8ec;
      --accent:#4c7ef3;
      --border:#22304a;
      --shadow:0 10px 26px rgba(0,0,0,.4);

      /* category colors */
      --clr-personal:#f6b73c;
      --clr-work:#56c6c6;
      --clr-school:#ff8ad4;
      --clr-event:#7dd957;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', "Khmer OS Content", "Battambang", sans-serif;
      color:var(--text); background:var(--bg);
      display:flex; gap:18px; padding:18px; overflow:hidden; }

    /* Subtle grid background */
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:linear-gradient(transparent 31px, rgba(255,255,255,.03) 32px),
                 linear-gradient(90deg, transparent 31px, rgba(255,255,255,.03) 32px);
      background-size:32px 32px;
    }

    .sidebar{
      width:280px; min-width:260px; background:var(--panel); border:1px solid var(--border);
      border-radius:18px; padding:18px; box-shadow:var(--shadow); height:calc(100vh - 36px); overflow:auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px; margin-bottom:12px;
      font-weight:800; letter-spacing:.4px; font-size:1.2rem;
    }
    .dot{width:10px; height:10px; border-radius:50%}

    .section-title{margin-top:16px; color:var(--muted); font-size:.85rem; letter-spacing:.06em}

    .page-list{margin:10px 0 6px; display:grid; gap:8px}
    .page{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 12px; background:var(--panel-2);
      border:1px solid var(--border); border-radius:14px; cursor:pointer; transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .page:hover{transform:translateY(-1px); border-color:#2a3b5f; background:#111a2a}
    .page:active{transform:translateY(0)}
    .page.active{outline:2px solid rgba(255,255,255,.08)}

    .btn{
      width:100%; padding:14px 16px; background:linear-gradient(180deg, #2f65f2, #3f59e8);
      color:white; border:none; border-radius:14px; cursor:pointer; font-weight:700;
      box-shadow:0 10px 18px rgba(76,126,243,.25); transition:transform .08s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn:hover{box-shadow:0 12px 22px rgba(76,126,243,.33); filter:brightness(1.02)}
    .btn:active{transform:translateY(1px)}
    .btn-outline{
      width:100%; padding:12px 14px; background:transparent; color:var(--text);
      border:1px solid var(--border); border-radius:14px; cursor:pointer; transition:background .12s ease, border-color .12s ease;
    }
    .btn-outline:hover{background:#111a2a; border-color:#2a3b5f}
    .btn-outline:active{transform:translateY(1px)}

    .nav-btns{display:flex; gap:8px}
    .nav-btn{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:var(--panel-2); border:1px solid var(--border); cursor:pointer; transition:background .12s ease, transform .08s ease, border-color .12s ease}
    .nav-btn:hover{background:#111a2a; border-color:#2a3b5f}
    .nav-btn:active{transform:translateY(1px)}

    .vspace{height:10px}

    .app{
      flex:1; background:var(--panel); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      overflow:hidden; display:flex; flex-direction:column;
    }
    .app-header{
      display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border);
    }
    .title{ font-size:1.25rem; font-weight:800; letter-spacing:.3px; }

    .calendar{ padding:14px; display:grid; grid-template-rows:auto 1fr; height:100%; }
    .dow{display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; color:var(--muted); font-size:.85rem; padding:6px 4px 8px}
    .grid{display:grid; grid-template-columns:repeat(7, 1fr); grid-auto-rows:110px; gap:8px; overflow:auto; padding-bottom:12px}

    .cell{
      position:relative; border:1px solid var(--border); border-radius:14px; background:var(--panel-2);
      padding:8px; display:flex; flex-direction:column; gap:6px; cursor:pointer; transition:border-color .15s, background .12s ease;
    }
    .cell:hover{border-color:#2a3b5f; background:#0f1929}
    .cell .day{font-weight:700; color:#d6d9df}
    .cell.out{opacity:.45}
    .cell.today{box-shadow:inset 0 0 0 2px var(--accent)}

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 8px; font-size:.8rem; border-radius:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      background:#1a2334; border:1px solid #263652;
    }
    .badge{width:8px; height:8px; border-radius:50%}

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); z-index:50; }
    .modal.open{ display:grid; }
    .card{ width:min(520px, 92vw); background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow:var(--shadow) }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ color:var(--muted); font-size:.85rem }
    input, select, textarea{ background:var(--panel-2); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    textarea{ resize:vertical; min-height:70px }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px }

    .legend{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 4px }
    .legend .filter{ display:flex; align-items:center; gap:8px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; cursor:pointer; transition:background .12s ease, border-color .12s ease }
    .legend .filter:hover{background:#111a2a; border-color:#2a3b5f}
    .legend .filter.active{ outline:2px solid rgba(255,255,255,.06) }

    .muted{ color:var(--muted) }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand"><span class="dot" style="background:var(--accent)"></span> MEANRITH YURIN</div>

    <div class="section-title">OPEN PAGE</div>
    <div class="page-list" id="pageList">
      <!-- Filled by JS with real pages (Dashboard, Personal, Work, School, Event) -->
    </div>

    <div class="section-title">QUICK ACTIONS</div>
    <button class="btn" id="addBtn">+ Add Task / Event</button>
    <div class="vspace"></div>
    <button class="btn-outline" id="exportWeek">Export PDF (This Week)</button>
    <div class="vspace"></div>
    <button class="btn-outline" id="exportRange">Export Range → PDF</button>
    <div class="vspace"></div>
    <button class="btn-outline" id="downloadJson" title="Backup to JSON">Backup JSON (optional)</button>
    <div class="vspace"></div>
    <button class="btn-outline" id="restoreJson" title="Restore from JSON">Restore JSON (optional)</button>
  </aside>

  <main class="app">
    <div class="app-header">
      <div class="title" id="title">My Calendar — August 2025</div>
      <div class="nav-btns">
        <button class="nav-btn" id="prevMonth" title="Previous month">⟨</button>
        <button class="nav-btn" id="nextMonth" title="Next month">⟩</button>
      </div>
    </div>

    <div class="calendar">
      <div class="legend" id="legend"></div>
      <div class="dow">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div class="modal" id="modal">
    <div class="card">
      <h3 style="margin:6px 0 12px">Add Task / Event</h3>
      <div class="row">
        <div class="field">
          <label>Title</label>
          <input id="m_title" placeholder="e.g., Team meeting" />
        </div>
        <div class="field">
          <label>Category</label>
          <select id="m_category"></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field">
          <label>Date</label>
          <input type="date" id="m_date" />
        </div>
        <div class="field">
          <label>Time</label>
          <input type="time" id="m_time" />
        </div>
      </div>
      <div class="field" style="margin-top:8px">
        <label>Notes</label>
        <textarea id="m_notes" placeholder="Optional details..."></textarea>
      </div>
      <div class="actions">
        <button class="btn-outline" id="cancelModal">Cancel</button>
        <button class="btn" id="saveModal">Save</button>
      </div>
    </div>
  </div>

  <!-- Range Export Modal -->
  <div class="modal" id="rangeModal">
    <div class="card">
      <h3 style="margin:6px 0 12px">Export Range → PDF</h3>
      <div class="row">
        <div class="field">
          <label>Start date</label>
          <input type="date" id="r_start" />
        </div>
        <div class="field">
          <label>End date</label>
          <input type="date" id="r_end" />
        </div>
      </div>
      <p class="muted" style="margin:8px 0 0">Export includes only <b>visible categories</b> (chips on top).</p>
      <div class="actions">
        <button class="btn-outline" id="r_cancel">Cancel</button>
        <button class="btn" id="r_export">Export PDF</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    const pad = n => String(n).padStart(2, '0');
    const toISODate = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISO = (s)=> { const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); };

    // ===== Storage layer =====
    const store = {
      get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
    }

    // ===== Categories =====
    const DEFAULT_CATEGORIES = [
      { id:'personal', name:'Personal', color:getComputedStyle(document.documentElement).getPropertyValue('--clr-personal').trim() },
      { id:'work',     name:'Work',     color:getComputedStyle(document.documentElement).getPropertyValue('--clr-work').trim() },
      { id:'school',   name:'School',   color:getComputedStyle(document.documentElement).getPropertyValue('--clr-school').trim() },
      { id:'event',    name:'Event',    color:getComputedStyle(document.documentElement).getPropertyValue('--clr-event').trim() },
    ];

    let categories = store.get('mc.categories', DEFAULT_CATEGORIES);

    // Pages: 'dashboard' (all), or one of the category ids
    let activePage = store.get('mc.activePage', 'dashboard');

    // Multi-filter chips state (legend). Default follows the active page.
    let activeCategoryIds = new Set(store.get('mc.activeCats', (activePage==='dashboard' ? categories.map(c=>c.id) : [activePage])));

    let events = store.get('mc.events', []); // {id,title,date,time,categoryId,notes}

    // current view state
    let viewDate = new Date();

    // ===== DOM refs =====
    const grid = document.getElementById('grid');
    const titleEl = document.getElementById('title');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    const pageList = document.getElementById('pageList');
    const legend = document.getElementById('legend');

    // Modal refs
    const modal = document.getElementById('modal');
    const m_title = document.getElementById('m_title');
    const m_category = document.getElementById('m_category');
    const m_date = document.getElementById('m_date');
    const m_time = document.getElementById('m_time');
    const m_notes = document.getElementById('m_notes');

    const addBtn = document.getElementById('addBtn');
    const cancelModal = document.getElementById('cancelModal');
    const saveModal = document.getElementById('saveModal');

    // Range export modal
    const rangeModal = document.getElementById('rangeModal');
    const r_start = document.getElementById('r_start');
    const r_end = document.getElementById('r_end');
    const r_cancel = document.getElementById('r_cancel');
    const r_export = document.getElementById('r_export');

    const exportWeekBtn = document.getElementById('exportWeek');
    const exportRangeBtn = document.getElementById('exportRange');

    const downloadJson = document.getElementById('downloadJson');
    const restoreJson = document.getElementById('restoreJson');

    // ===== Page & Category Rendering =====
    function setPage(id){
      activePage = id; store.set('mc.activePage', id);
      activeCategoryIds = new Set(id==='dashboard' ? categories.map(c=>c.id) : [id]);
      store.set('mc.activeCats', Array.from(activeCategoryIds));
      updateTitle(); renderCategoriesUI(); renderMonth();
    }

    function renderCategoriesUI(){
      pageList.innerHTML = '';
      legend.innerHTML = '';

      const pages = [{ id:'dashboard', name:'My Calendar', color: 'var(--accent)' }, ...categories];

      pages.forEach(p => {
        // left page list (radio-style single select)
        const el = document.createElement('div');
        el.className = 'page' + (activePage===p.id ? ' active' : '');
        el.innerHTML = `<div style="display:flex; align-items:center; gap:10px"><span class="dot" style="background:${p.color}"></span><div>${p.name}</div></div>`;
        el.addEventListener('click', ()=> setPage(p.id));
        pageList.appendChild(el);
      });

      // top legend = multi-select filters for export/visibility
      categories.forEach(cat => {
        const f = document.createElement('div');
        f.className = 'filter' + (activeCategoryIds.has(cat.id)?' active':'');
        f.innerHTML = `<span class="badge" style="background:${cat.color}"></span><span>${cat.name}</span>`;
        f.addEventListener('click', ()=>{
          if(activeCategoryIds.has(cat.id)) activeCategoryIds.delete(cat.id); else activeCategoryIds.add(cat.id);
          if(activeCategoryIds.size===0){ activeCategoryIds.add(cat.id); }
          store.set('mc.activeCats', Array.from(activeCategoryIds));
          renderCategoriesUI(); renderMonth();
        });
        legend.appendChild(f);
      });

      // category dropdown in modal
      m_category.innerHTML = categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }

    function updateTitle(){
      const monthName = viewDate.toLocaleString(undefined,{month:'long'});
      const year = viewDate.getFullYear();
      let pageLabel = 'My Calendar';
      if(activePage!=='dashboard'){
        pageLabel = categories.find(c=>c.id===activePage)?.name || 'My Calendar';
      }
      titleEl.textContent = `${pageLabel} — ${monthName} ${year}`;
    }

    // ===== Calendar Grid =====
    function getMonthMatrix(year, month){
      // returns 6 weeks x 7 days matrix of Date objects
      const first = new Date(year, month, 1);
      const start = new Date(first);
      // move to Sunday of first week
      start.setDate(first.getDate() - first.getDay());
      const weeks = [];
      for(let w=0; w<6; w++){
        const row = [];
        for(let d=0; d<7; d++){
          const curr = new Date(start);
          curr.setDate(start.getDate() + w*7 + d);
          row.push(curr);
        }
        weeks.push(row);
      }
      return weeks;
    }

    function eventsOn(date){
      const iso = toISODate(date);
      return events.filter(e => e.date===iso && activeCategoryIds.has(e.categoryId));
    }

    function renderMonth(){
      updateTitle();
      grid.innerHTML = '';
      const y = viewDate.getFullYear();
      const m = viewDate.getMonth();
      const matrix = getMonthMatrix(y,m);
      const todayISO = toISODate(new Date());

      matrix.flat().forEach(d =>{
        const cell = document.createElement('div');
        const inMonth = d.getMonth()===m;
        cell.className = 'cell' + (!inMonth? ' out':'') + (toISODate(d)===todayISO? ' today':'');
        cell.innerHTML = `<div class="day">${d.getDate()}</div>`;

        eventsOn(d).sort((a,b)=> (a.time||'99:99').localeCompare(b.time||'99:99')).forEach(ev =>{
          const cat = categories.find(c=>c.id===ev.categoryId);
          const pill = document.createElement('div');
          pill.className = 'pill';
          pill.innerHTML = `<span class="badge" style="background:${cat?.color}"></span><span>${ev.time? ev.time+' · ' : ''}${ev.title}</span>`;
          cell.appendChild(pill);
        });

        cell.addEventListener('click', ()=> openModal({date: toISODate(d)}));
        grid.appendChild(cell);
      });
    }

    // ===== Modal logic =====
    function openModal(prefill={}){
      m_title.value = prefill.title || '';
      m_date.value = prefill.date || toISODate(new Date());
      m_time.value = prefill.time || '';
      m_notes.value = prefill.notes || '';
      // default category follows page: if page is dashboard -> keep previously selected or first category
      m_category.value = prefill.categoryId || (activePage==='dashboard' ? (categories[0]?.id) : activePage);
      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); }

    addBtn.addEventListener('click', ()=> openModal({ date: toISODate(new Date()) }));
    cancelModal.addEventListener('click', closeModal);

    saveModal.addEventListener('click', ()=>{
      const title = m_title.value.trim(); if(!title){ m_title.focus(); return; }
      const e = {
        id: crypto.randomUUID?.() || String(Date.now()),
        title,
        date: m_date.value,
        time: m_time.value || '',
        categoryId: m_category.value,
        notes: m_notes.value.trim()
      };
      events.push(e); store.set('mc.events', events);
      closeModal(); renderMonth();
    });

    // ===== Month navigation =====
    prevBtn.addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()-1); renderMonth(); });
    nextBtn.addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()+1); renderMonth(); });

    // ===== Export: This Week (no print dialog) =====
    function startOfWeek(d){ const x=new Date(d); x.setDate(d.getDate()-d.getDay()); x.setHours(0,0,0,0); return x; }
    function endOfWeek(d){ const x=startOfWeek(d); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
    function inRange(dateISO, a, b){ const t=parseISO(dateISO).getTime(); return t>=a.getTime() && t<=b.getTime(); }

    function collectEvents(startDate, endDate){
      // filtered by active categories
      const rows = events
        .filter(e => activeCategoryIds.has(e.categoryId) && inRange(e.date, startDate, endDate))
        .sort((a,b)=> a.date===b.date ? (a.time||'99:99').localeCompare(b.time||'99:99') : a.date.localeCompare(b.date))
        .map(e=>{
          const c = categories.find(x=>x.id===e.categoryId);
          return [ e.date, e.time || '—', c?.name || '', e.title, e.notes || '' ];
        });
      return rows;
    }

    async function exportPDF({startDate, endDate, filename}){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});

      const pageLabel = (activePage==='dashboard') ? 'All Categories' : (categories.find(c=>c.id===activePage)?.name || 'All');
      const title = `Calendar Export — ${pageLabel}`;
      const sub = `${startDate.toDateString()}  →  ${endDate.toDateString()}`;
      doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.text(title, 40, 40);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(11); doc.setTextColor(120);
      doc.text(sub, 40, 60);
      doc.setTextColor(20);

      const rows = collectEvents(startDate, endDate);
      if(rows.length===0){
        doc.text('No events in this range.', 40, 92);
      }else{
        doc.autoTable({
          startY: 84,
          head: [['Date','Time','Category','Title','Notes']],
          body: rows,
          styles: { fontSize: 10, cellPadding: 6 },
          headStyles: { fillColor:[46, 74, 120] },
          theme: 'grid',
        });
      }

      doc.save(filename);
    }

    exportWeekBtn.addEventListener('click', ()=>{
      const now = new Date();
      const a = startOfWeek(now); const b = endOfWeek(now);
      exportPDF({startDate:a, endDate:b, filename:`calendar-week-${a.getFullYear()}-${pad(a.getMonth()+1)}-${pad(a.getDate())}.pdf`});
    });

    // ===== Export Range modal =====
    exportRangeBtn.addEventListener('click', ()=>{
      const todayISO = toISODate(new Date());
      r_start.value = todayISO;
      r_end.value = todayISO;
      rangeModal.classList.add('open');
    });
    r_cancel.addEventListener('click', ()=> rangeModal.classList.remove('open'));
    r_export.addEventListener('click', ()=>{
      const a = parseISO(r_start.value);
      const b = parseISO(r_end.value);
      if(!(a instanceof Date) || !(b instanceof Date) || isNaN(a) || isNaN(b) || a>b){
        alert('Please choose a valid date range.');
        return;
      }
      rangeModal.classList.remove('open');
      exportPDF({startDate:a, endDate:b, filename:`calendar-${r_start.value}_to_${r_end.value}.pdf`});
    });

    // ===== Backup/Restore JSON (optional) =====
    downloadJson.addEventListener('click', ()=>{
      const data = { categories, activePage, activeCategoryIds: Array.from(activeCategoryIds), events };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='calendar-backup.json'; a.click(); URL.revokeObjectURL(url);
    });
    restoreJson.addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = ()=>{
        const file = inp.files[0]; if(!file) return;
        const fr = new FileReader(); fr.onload = ()=>{
          try{
            const data = JSON.parse(fr.result);
            categories = data.categories || DEFAULT_CATEGORIES;
            activePage = data.activePage || 'dashboard';
            activeCategoryIds = new Set(data.activeCategoryIds || (activePage==='dashboard' ? categories.map(c=>c.id) : [activePage]));
            events = data.events || [];
            store.set('mc.categories', categories);
            store.set('mc.activePage', activePage);
            store.set('mc.activeCats', Array.from(activeCategoryIds));
            store.set('mc.events', events);
            renderCategoriesUI(); renderMonth();
          }catch(err){ alert('Invalid JSON file.'); }
        };
        fr.readAsText(file);
      };
      inp.click();
    });

    // ===== Init =====
    function init(){
      renderCategoriesUI();
      renderMonth();
    }
    init();
  </script>
</body>
</html>
